.PHONY: help install dev prod test migrate seed clean format lint docker-build docker-up docker-down

# Variables
PYTHON := python
PIP := pip
UVICORN := uvicorn
ALEMBIC := alembic
PYTEST := pytest

# Default target
.DEFAULT_GOAL := help

help: ## Show this help message
	@echo "Ruqya Healing Hub Backend - Available Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Install dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	$(PIP) install -r requirements.txt
	@echo "âœ… Dependencies installed!"

install-dev: ## Install development dependencies
	@echo "ğŸ“¦ Installing development dependencies..."
	$(PIP) install -r requirements.txt
	$(PIP) install black flake8 mypy
	@echo "âœ… Development dependencies installed!"

dev: ## Run development server with auto-reload
	@echo "ğŸš€ Starting development server..."
	$(UVICORN) app.main:app --reload --host 0.0.0.0 --port 8000

prod: ## Run production server
	@echo "ğŸš€ Starting production server..."
	$(UVICORN) app.main:app --host 0.0.0.0 --port 8000 --workers 4

test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	$(PYTEST) tests/ -v --cov=app --cov-report=html --cov-report=term

test-watch: ## Run tests in watch mode
	@echo "ğŸ§ª Running tests in watch mode..."
	$(PYTEST) tests/ -v --watch

migrate-init: ## Initialize Alembic migrations
	@echo "ğŸ—„ï¸  Initializing migrations..."
	$(ALEMBIC) init alembic
	@echo "âœ… Migrations initialized!"

migrate-create: ## Create a new migration (use MSG="message")
	@echo "ğŸ—„ï¸  Creating migration: $(MSG)"
	$(ALEMBIC) revision --autogenerate -m "$(MSG)"
	@echo "âœ… Migration created!"

migrate-up: ## Apply all pending migrations
	@echo "ğŸ—„ï¸  Applying migrations..."
	$(ALEMBIC) upgrade head
	@echo "âœ… Migrations applied!"

migrate-down: ## Rollback last migration
	@echo "ğŸ—„ï¸  Rolling back migration..."
	$(ALEMBIC) downgrade -1
	@echo "âœ… Migration rolled back!"

migrate-history: ## Show migration history
	@echo "ğŸ“œ Migration history:"
	$(ALEMBIC) history

migrate-current: ## Show current migration version
	@echo "ğŸ“ Current migration:"
	$(ALEMBIC) current

seed: ## Seed database with initial data
	@echo "ğŸŒ± Seeding database..."
	$(PYTHON) scripts/seed_data.py
	@echo "âœ… Database seeded!"

seed-admin: ## Create admin user only
	@echo "ğŸ‘¤ Creating admin user..."
	$(PYTHON) scripts/create_admin.py
	@echo "âœ… Admin user created!"

clean: ## Clean up generated files
	@echo "ğŸ§¹ Cleaning up..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Cleaned up!"

format: ## Format code with Black
	@echo "ğŸ¨ Formatting code..."
	black app/ tests/
	@echo "âœ… Code formatted!"

lint: ## Lint code with Flake8
	@echo "ğŸ” Linting code..."
	flake8 app/ tests/ --max-line-length=100 --exclude=__pycache__,alembic
	@echo "âœ… Code linted!"

type-check: ## Type check with MyPy
	@echo "ğŸ” Type checking..."
	mypy app/ --ignore-missing-imports
	@echo "âœ… Type check complete!"

check: format lint type-check ## Run all code quality checks

db-create: ## Create database (PostgreSQL)
	@echo "ğŸ—„ï¸  Creating database..."
	createdb ruqya_db
	@echo "âœ… Database created!"

db-drop: ## Drop database (PostgreSQL)
	@echo "âš ï¸  Dropping database..."
	dropdb ruqya_db
	@echo "âœ… Database dropped!"

db-reset: db-drop db-create migrate-up seed ## Reset database completely
	@echo "ğŸ”„ Database reset complete!"

logs: ## Show application logs
	@echo "ğŸ“‹ Showing logs..."
	tail -f logs/app.log

shell: ## Open Python shell with app context
	@echo "ğŸ Opening Python shell..."
	$(PYTHON) -i scripts/shell.py

routes: ## Show all API routes
	@echo "ğŸ›£ï¸  API Routes:"
	$(PYTHON) scripts/show_routes.py

backup: ## Backup database
	@echo "ğŸ’¾ Creating database backup..."
	pg_dump ruqya_db > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup created!"

docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker build -t ruqya-backend .
	@echo "âœ… Docker image built!"

docker-up: ## Start Docker containers
	@echo "ğŸ³ Starting Docker containers..."
	docker-compose up -d
	@echo "âœ… Docker containers started!"

docker-down: ## Stop Docker containers
	@echo "ğŸ³ Stopping Docker containers..."
	docker-compose down
	@echo "âœ… Docker containers stopped!"

docker-logs: ## Show Docker logs
	@echo "ğŸ“‹ Docker logs:"
	docker-compose logs -f

setup: install migrate-up seed ## Complete initial setup
	@echo "ğŸ‰ Setup complete! Run 'make dev' to start the server."

quick-start: ## Quick start for development
	@echo "âš¡ Quick starting..."
	@make install
	@make migrate-up
	@make seed
	@make dev
	